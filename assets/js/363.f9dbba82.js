(window.webpackJsonp=window.webpackJsonp||[]).push([[363],{583:function(t,s,e){"use strict";e.r(s);var a=e(0),r=Object(a.a)({},(function(){var t=this.$createElement;this._self._c;return this._m(0)}),[function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"content"},[e("h1",{attrs:{id:"elastalert-安装教程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#elastalert-安装教程"}},[t._v("#")]),t._v(" ElastAlert 安装教程")]),t._v(" "),e("h2",{attrs:{id:"本内容你将获得"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#本内容你将获得"}},[t._v("#")]),t._v(" 本内容你将获得")]),t._v(" "),e("ul",[e("li",[t._v("安装预警")])]),t._v(" "),e("h2",{attrs:{id:"安装环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装环境"}},[t._v("#")]),t._v(" 安装环境")]),t._v(" "),e("ul",[e("li",[t._v("Centos7.4_x64")]),t._v(" "),e("li",[t._v("Elasticsearch 6.4.0")]),t._v(" "),e("li",[t._v("Kibana 6.4.0")])]),t._v(" "),e("h2",{attrs:{id:"安装教程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装教程"}},[t._v("#")]),t._v(" 安装教程")]),t._v(" "),e("p",[t._v("下载代码，注意使用的版本号和 python 版本，es 使用的版本是 6.4.0,所以使用的 elastalert 版本不能太高")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#安装依赖包")]),t._v("\nyum "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" gcc libffi-devel python-devel openssl-devel python-setuptools "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" https://bootstrap.pypa.io/get-pip.py -o get-pip.py    下载安装脚本\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" python get-pip.py     运行安装脚本\n")])])]),e("p",[t._v("安装 python")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("yum "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" python\n")])])]),e("p",[t._v("安装 elastalert")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone --branch v0.1.39 https://github.com/Yelp/elastalert.git\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" elastalert\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#安装")]),t._v("\n pip "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"setuptools>=11.3"')]),t._v("\n\n centos7.4\npip  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("setuptools")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("32.2")]),t._v(".0\npip "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" -r requirements.txt\n\npython setup.py "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n\n 或者 pip "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" elastalert\n Elasticsearch "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),t._v("+:\npip "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"elasticsearch>=5.0.0"')]),t._v("\n")])])]),e("p",[t._v("配置规则")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" elastalert\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" config.yaml.example config.yaml "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#基本信息")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" config.yaml\n")])])]),e("p",[t._v("定义规则目录")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#将从该文件夹下读取*.yaml配置文件")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules_folder")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" alinesno_rules\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#查询es中 elastalert_status 索引的频率，也可以是minutes，days 等等")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run_every")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hours")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n 每两分钟查询一次es 匹配 rules 的数据，存放到elastalert_status中\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("buffer_time")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("minutes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#host")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("es_host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 127.0.0.1\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#port")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("es_port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9200")]),t._v("\n Option basic"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("auth username and password for Elasticsearch\n "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("es_username")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" username\n "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("es_password")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pwd\n")])])]),e("p",[t._v("规则目录说明，此处的配置文件是指 config.yaml 文件")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("名称")]),t._v(" "),e("th",[t._v("说明")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("rules_folder")]),t._v(" "),e("td",[t._v("ElastAlert 将加载规则配置文件的地方，它将尝试加载文件夹中的每个.yaml 文件。")])]),t._v(" "),e("tr",[e("td",[t._v("run_every")]),t._v(" "),e("td",[t._v("ElastAlert 查询 Elasticsearch 的频率。")])]),t._v(" "),e("tr",[e("td",[t._v("buffer_time")]),t._v(" "),e("td",[t._v("是查询窗口的大小，从每个查询运行的时间向后延伸。对于其中 use_count_query 或 use_terms_query 设置为 true 的规则，此值将被忽略。")])]),t._v(" "),e("tr",[e("td",[t._v("es_host")]),t._v(" "),e("td",[t._v("是 Elasticsearch 集群的地址，ElastAlert 将存储有关其状态、查询运行、警报和错误的数据。每个规则也可以设置不同的 elasticsearch 主机进行查询。")])]),t._v(" "),e("tr",[e("td",[t._v("es_port")]),t._v(" "),e("td",[t._v("Elasticsearch 对应的端口。")])]),t._v(" "),e("tr",[e("td",[t._v("use_ssl")]),t._v(" "),e("td",[t._v("（可选的）是否使用 TLS;连接到 es_host；设置为 True 或 False。")])]),t._v(" "),e("tr",[e("td",[t._v("verify_certs")]),t._v(" "),e("td",[t._v("（可选的）是否验证 TLS 证书; 设置为 True 或 False，默认是 True。")])]),t._v(" "),e("tr",[e("td",[t._v("client_cert")]),t._v(" "),e("td",[t._v("（可选的）PEM 证书的路径。")])]),t._v(" "),e("tr",[e("td",[t._v("client_key")]),t._v(" "),e("td",[t._v("（可选的） 作为客户端密钥使用的私钥文件的路径。")])]),t._v(" "),e("tr",[e("td",[t._v("ca_certs")]),t._v(" "),e("td",[t._v("（可选的） 用于验证 SSL 连接的 CA 证书的路径。")])]),t._v(" "),e("tr",[e("td",[t._v("es_username")]),t._v(" "),e("td",[t._v("（可选的） 用于连接 Elasticsearch 的 basic-auth 用户名。")])]),t._v(" "),e("tr",[e("td",[t._v("es_password")]),t._v(" "),e("td",[t._v("（可选的） 用于连接 Elasticsearch 的密码。")])]),t._v(" "),e("tr",[e("td",[t._v("es_url_prefix")]),t._v(" "),e("td",[t._v("（可选的） Elasticsearch 端点的 URL 前缀。")])]),t._v(" "),e("tr",[e("td",[t._v("es_send_get_body_as")]),t._v(" "),e("td",[t._v("（可选的） 查询 Elasticsearch 方法- GET，POST 或 source，默认是 GET。")])]),t._v(" "),e("tr",[e("td",[t._v("writeback_index")]),t._v(" "),e("td",[t._v("是 ElastAlert 将存储数据的索引名称。")])]),t._v(" "),e("tr",[e("td",[t._v("alert_time_limit")]),t._v(" "),e("td",[t._v("是失败警报的重试窗口。")])])])]),t._v(" "),e("p",[t._v("配置规则")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[t._v(" 规则名称(唯一)\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Aalinesno服务异常\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" change\n 索引\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("index")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" alinesno"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("*\n The field to look for changes in\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("compare_key")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" message\n Ignore documents without the compare_key (country_name) field\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ignore_null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n (Required"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" change specific)\n 关键字查询\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("query_key")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ERROR\n (Required"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" change specific)\n The value of compare_key must change in two events that are less than timeframe apart to trigger an alert\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeframe")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("minutes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v("\n")])])]),e("h4",{attrs:{id:"rule"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#rule"}},[t._v("#")]),t._v(" rule")]),t._v(" "),e("p",[t._v("设置各自独立以文件方式存储在 rules_folder 设置的目录里。其中可以定义下面这些参数：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("名称")]),t._v(" "),e("th",[t._v("说明")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("name")]),t._v(" "),e("td",[t._v("每个规则需要有自己独立的名称，一旦重复，进程将无法启动。")])]),t._v(" "),e("tr",[e("td",[t._v("type")]),t._v(" "),e("td",[t._v("选择某一种数据验证方式。")])]),t._v(" "),e("tr",[e("td",[t._v("index")]),t._v(" "),e("td",[t._v("从某类索引里读取数据，目前已经支持 Ymd 格式，需要先设置 use_strftime_index：true，"),e("br"),t._v("然后匹配索引，配置形如：index：logstash-es-test-％Y。％m。％d，表示匹配 logstash-ES-测试名称开头，以年月日作为索引后缀的索引。")])]),t._v(" "),e("tr",[e("td",[t._v("filter")]),t._v(" "),e("td",[t._v("设置向 ES 请求的过滤条件。")])]),t._v(" "),e("tr",[e("td",[t._v("timeframe")]),t._v(" "),e("td",[t._v("累积触发报警的时长。")])]),t._v(" "),e("tr",[e("td",[t._v("alert")]),t._v(" "),e("td",[t._v("设置触发报警时执行哪些报警手段。")])])])]),t._v(" "),e("h4",{attrs:{id:"type"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#type"}},[t._v("#")]),t._v(" type")]),t._v(" "),e("p",[t._v("不同的类型还有自己独特的配置选项。目前 ElastAlert 有以下几种自带 ruletype：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("名称")]),t._v(" "),e("th",[t._v("说明")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("any")]),t._v(" "),e("td",[t._v("只要有匹配就报警;")])]),t._v(" "),e("tr",[e("td",[t._v("blacklist")]),t._v(" "),e("td",[t._v("compare_key 字段的内容匹配上 blacklist 数组里任意内容;")])]),t._v(" "),e("tr",[e("td",[t._v("whitelist")]),t._v(" "),e("td",[t._v("compare_key 字段的内容一个都没能匹配上 whitelist 数组里内容;")])]),t._v(" "),e("tr",[e("td",[t._v("change")]),t._v(" "),e("td",[t._v("在相同 query_key 条件下，compare_key 字段的内容，在 timeframe 范围内发送变化;")])]),t._v(" "),e("tr",[e("td",[t._v("frequency")]),t._v(" "),e("td",[t._v("在相同 query_key 条件下，timeframe 范围内有 num_events 个被过滤出来的异常;")])]),t._v(" "),e("tr",[e("td",[t._v("spike")]),t._v(" "),e("td",[t._v("相同在 query_key 条件下，两个前后 timeframe 范围内数据量相差比例超过 spike_height。"),e("br"),t._v("可以其中通过 spike_type 设置具体涨跌方向的英文 up，down，both。可以还通过 threshold_ref 设置要"),e("br"),t._v("求上一个周期数据量的下限，threshold_cur 设置"),e("br"),t._v("要求当前周期数据量的下限，如果数据量不到下限，也不触发;")])]),t._v(" "),e("tr",[e("td",[t._v("flatline")]),t._v(" "),e("td",[t._v("timeframe 范围内，量数据小于 threshold 阈值;")])]),t._v(" "),e("tr",[e("td",[t._v("new_term")]),t._v(" "),e("td",[t._v("fields 字段新出现之前 terms_window_size（默认 30 天）"),e("br"),t._v("范围内最多的 terms_size（默认 50）个结果以外的数据;")])]),t._v(" "),e("tr",[e("td",[t._v("cardinality")]),t._v(" "),e("td",[t._v("在相同 query_key 条件下，timeframe 范围内 cardinality_field 的"),e("br"),t._v("值超过 max_cardinality 或者低于 min_cardinality。")])])])]),t._v(" "),e("p",[t._v("初始化")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("elastalert-create-index\nelastalert-test-rule alinesno_rules/alinesno_rule.yaml\n")])])]),e("table",[e("thead",[e("tr",[e("th",[t._v("名称")]),t._v(" "),e("th",[t._v("说明")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("elastalert-create-index")]),t._v(" "),e("td",[t._v("ElastAlert 会脚执行记录存放到一个 ES 索引中，该命令就是用来创建这个索引的，"),e("br"),t._v("默认情况下，索引名叫 elastalert_status。其中有 4 个_type，都有自己的@timestamp 字段，"),e("br"),t._v("所以同样也可以用 kibana 来查看这个索引的日志记录情况。")])]),t._v(" "),e("tr",[e("td",[t._v("elastalert-rule-from-kibana")]),t._v(" "),e("td",[t._v("从 Kibana 已保存的仪表盘中读取 Filtering 设置，帮助生成 config.yaml 里的配置。"),e("br"),t._v("不过注意，它只会读取过滤，不包括查询。")])]),t._v(" "),e("tr",[e("td",[t._v("elastalert-test-rule")]),t._v(" "),e("td",[t._v("测试自定义配置中的规则设置。")])])])]),t._v(" "),e("p",[t._v("运行")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("python -m elastalert.elastalert --config ./config.yaml --verbose --rule alinesno_rules/alinesno_rule.yaml\n")])])]),e("h2",{attrs:{id:"其它"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#其它"}},[t._v("#")]),t._v(" 其它")]),t._v(" "),e("ul",[e("li",[t._v("略")])])])}],!1,null,null,null);s.default=r.exports}}]);