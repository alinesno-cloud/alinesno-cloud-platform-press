# 容器化集成

## 示例工程

系统应用集成示例工程[打开](https://gitee.com/alinesno-cloud/alinesno-demo-gateway-open/tree/master/demo-business-shop)

## 本内容你将获得

- 快速集成容器打包的方式和多种打包方式
- 前后端打包的方式
- 前端打包自定义后端域名方式
- 容器上传镜像中心方式

## 服务工程容器化

这里主要是集成`jib-maven-plugin`插件，集成的是阿里云镜像仓库

### 配置服务器镜像认证

服务器配置 docker-login，如下:

```shell
REGISTRY_USERNAME=
REGISTRY_PASSWORD=

docker login --username=$REGISTRY_USERNAME --password=$REGISTRY_PASSWORD registry.cn-shenzhen.aliyuncs.com
```

### 容器化打包

> 账号名密码可以使用 jenkinsfile 自定义配置，这里做了显示配置，不太安全，例子待补充

```shell
# 环境变量配置
export projectName=alinesno-cloud-demo-boot

# 自定义镜像创建和认证
export DOCKER_REGISTRY=registry.cn-shenzhen.aliyuncs.com
export REGISTRY_NAMESPACE=alinesno-cloud-incubator
export REGISTRY_USERNAME=
export REGISTRY_PASSWORD=

mvn -B -U -f ${projectName}/pom.xml install package
mvn -B -U -f ${projectName}/pom.xml clean compile jib:build -Ddocker.registry.name=${REGISTRY_NAMESPACE} -Djib.to.auth.username=${REGISTRY_USERNAME}  -Djib.to.auth.password=${REGISTRY_PASSWORD}
```

### 运行 docker

> k8s 请参考示例工程

运行工程，此处注意不要出现空格

```shell
ALIYUN_CR_HOST=registry.cn-shenzhen.aliyuncs.com
ALIYUN_CR_NAMESPACE=alinesno-cloud-incubator
PRO_NAME=alinesno-cloud-base-authority-boot
PRO_VERSION=2.1.2-RC
EXPOSE_PORT=8080
DOCKER_PORT=8080
PROFILES_ACTIVE=pro

docker rm -f $PRO_NAME  || true
docker pull $ALIYUN_CR_HOST/$ALIYUN_CR_NAMESPACE/$PRO_NAME:$PRO_VERSION
docker run \
-e JAVA_TOOL_OPTIONS="-Dspring.profiles.active=$PROFILES_ACTIVE" \
-p $EXPOSE_PORT:$DOCKER_PORT \
--name $PRO_NAME  \
--restart="always" \
-d $ALIYUN_CR_HOST/$ALIYUN_CR_NAMESPACE/$PRO_NAME:$PRO_VERSION
```

后台查询容器运行的情况`docker ps | grep xxxx`，即可查看监控

## 前端工程容器化

这里主要集成的是 maven 打包插件，与 maven 工程整合构建打包

### 前端工程打包

前端工程打成容器镜像

```shell
projectName=alinesno-cloud-demo-ui

# 镜像构建设置变量
export docker_repostory=registry.cn-shenzhen.aliyuncs.com
export docker_registry_name=alinesno-cloud-incubator
export project_artifactid=alinesno-cloud-demo-ui
export project_version=2.1.2-RC

cd ${projectName}/docker
bash ${projectName}/docker/build-docker.sh
```

其它`build-docker.sh`请查看示例工程

### 自定义后端地址

这里主要是使用 shell 进行全局的替换，查看`replace_api_url.sh`文件配置，主要的替换命令如下:

```shell
# config cdn path
find '/usr/share/nginx/html' -type f \( -name "*.js" -o -name "*.html" \) -exec sed -i -e 's,SERVER_CDN_URL,'"$SERVER_CDN_URL"',g' {} \;
```

### 工程发布

如下发布示例

```shell
ALIYUN_CR_HOST=registry.cn-shenzhen.aliyuncs.com
ALIYUN_CR_NAMESPACE=alinesno-cloud-incubator
PRO_NAME=alinesno-cloud-demo-ui
PRO_VERSION=2.1.2-RC
EXPOSE_PORT=8080
DOCKER_PORT=80

docker rm -f $PRO_NAME  || true
docker pull $ALIYUN_CR_HOST/$ALIYUN_CR_NAMESPACE/$PRO_NAME:$PRO_VERSION
docker run \
-p $EXPOSE_PORT:$DOCKER_PORT \
-e API_BASE_URL="http://alinesno-demo.admin.beta.linesno.com" \
-e SERVER_CDN_URL="http://data.linesno.com/alinesno-cloud-demo-ui" \
-e SERVER_STORAGE_UPLOAD_URL="http://alinesno-demo.admin.beta.linesno.com/common/storage/upload" \
-e SERVER_STORAGE_DISPLAY_URL="http://alinesno-demo.admin.beta.linesno.com/common/storage/displayImg/" \
 --name $PRO_NAME  \
--restart="always" \
-d $ALIYUN_CR_HOST/$ALIYUN_CR_NAMESPACE/$PRO_NAME:$PRO_VERSION
```

## 其它

- 无
